---
import type { GetStaticPaths, Page } from "astro";
import type { Blog } from "src/types/microcms/blogs";

import UnderPageLayout from "@layouts/UnderPageLayout.astro";
import { client } from "@libs/microcms";
import { Picture } from "@astrojs/image/components";
import FormattedDate from "@components/FormattedDate.svelte";
import Pagination from "@components/Pagination/Pagination.astro";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const { totalCount } = await client.getList<Blog>({
    endpoint: "news",
    queries: { limit: 0 },
  });

  return paginate(
    Array.from({ length: totalCount }).map(() => ({})),
    { pageSize: 10 }
  );
};

export interface Props {
  page: Page;
}

const { page } = Astro.props;

const { contents: news } = await client.getList<Blog>({
  endpoint: "news",
  queries: {
    limit: 10,
    offset: page.start,
    fields: "id,title,eyecatch,thumbnail,image,createdAt,publishedAt,release_date",
    orders: "-release_date",
  },
});
---

<UnderPageLayout
  mainLabel="NEWS"
  subLabel="お知らせ"
  title="お知らせ"
  noindex={page.currentPage !== 1}
>
  <ul class="mx-auto grid max-w-2xl grid-cols-1 gap-5 sm:gap-8 lg:gap-16">
    {
      news.map(({ id, title, eyecatch, thumbnail, image, createdAt, publishedAt, release_date }) => {
        const imageUrl = eyecatch?.url || thumbnail?.url || image?.url;
        return (
          <li>
            <a href={`/news/${id}`} class="flex">
              {imageUrl && (
                <div class="mr-4 w-1/3 max-w-[10rem] flex-none sm:mr-8 lg:mr-12">
                  <Picture
                    src={imageUrl}
                    widths={[320, 640, 960]}
                    aspectRatio={1}
                    width={320}
                    height={320}
                    sizes="20rem"
                    alt=""
                  />
                </div>
              )}
              <div class="sm:justify flex flex-1 flex-col justify-between sm:justify-center sm:gap-6">
                <h2 class="line-clamp-3 text-sm leading-relaxed sm:text-lg">
                  {title}
                </h2>
                <FormattedDate
                  class="font-english text-xs sm:text-sm"
                  date={release_date || publishedAt || createdAt}
                />
              </div>
            </a>
          </li>
        );
      })
    }
  </ul>

  <Pagination class="mt-16 sm:mt-24 lg:mt-32" page={page} />
</UnderPageLayout>
