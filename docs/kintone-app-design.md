# kintoneアプリ設計ドキュメント

このドキュメントでは、サイトコンテンツ管理用のkintoneアプリの設計について説明します。

## 概要

サイトのコンテンツを管理するために、以下の2つのkintoneアプリを使用します：

1. **サイトニュース管理**: ニュース記事を管理
2. **固定ページ管理**: 固定ページ（会社概要など）を管理

## 1. サイトニュース管理アプリ

### アプリ名
`サイトニュース管理`

### フィールド構成

| フィールド名 | フィールドコード | 種類 | 必須 | 説明 |
|------------|---------------|------|------|------|
| タイトル | `title` | 文字列（1行） | ✓ | ニュース記事のタイトル |
| 本文 | `content` | リッチエディタ | ✓ | ニュース記事の本文（HTML形式） |
| 概要 | `overview` | 文字列（複数行） | - | 記事の概要・要約 |
| リリース日 | `release_date` | 日時 | ✓ | 公開日時（ソート用） |
| 公開日 | `publishedAt` | 日時 | - | 公開日時（表示用） |
| サムネイル画像 | `thumbnail` | ファイル | - | 一覧表示用のサムネイル画像 |
| アイキャッチ画像 | `eyecatch` | ファイル | - | 詳細ページ用のアイキャッチ画像 |
| 画像 | `image` | ファイル | - | 画像（eyecatch/thumbnailの代替） |
| タグ | `tag` | ドロップダウン | - | 記事のカテゴリ |
| 公開 | `publish` | チェックボックス（複数選択） | ✓ | 公開環境（選択肢：開発、本番） |
| microCMS ID | `microcms_id` | 文字列（1行） | - | microCMSのID（移行時の互換性のため） |
| 投稿ID | `id` | 文字列（1行） | ✓ | 投稿ID（自動採番プラグインで生成） |

### 設定

- **投稿ID**: 自動採番プラグインで生成（既存プラグインを使用、実装不要）
- **並び順**: リリース日の降順（最新が上）
- **公開フィールドの選択肢**: 「開発」「本番」（両方選択可能）

### データ取得時のフィルタリング

- 開発環境ビルド: `publish` に「開発」が含まれるレコードのみ取得
- 本番環境ビルド: `publish` に「本番」が含まれるレコードのみ取得

## 2. 固定ページ管理アプリ

### アプリ名
`固定ページ管理`

### フィールド構成

| フィールド名 | フィールドコード | 種類 | 必須 | 説明 |
|------------|---------------|------|------|------|
| ページ識別子 | `page_id` | 文字列（1行） | ✓ | ページを識別するID（例：company, aboutjoyzo, story等） |
| ページ名 | `page_name` | 文字列（1行） | ✓ | ページ名（表示用） |
| タイトル | `title` | 文字列（1行） | ✓ | ページタイトル |
| サブタイトル | `subtitle` | 文字列（1行） | - | サブタイトル |
| 本文1 | `content1` | リッチエディタ | - | ページの本文（第1セクション） |
| 本文2 | `content2` | リッチエディタ | - | ページの本文（第2セクション） |
| 本文3 | `content3` | リッチエディタ | - | ページの本文（第3セクション、必要に応じて） |
| 公開 | `publish` | チェックボックス（複数選択） | ✓ | 公開環境（選択肢：開発、本番） |
| 更新日時 | `updatedAt` | 日時 | - | 最終更新日時 |
| microCMS ID | `microcms_id` | 文字列（1行） | - | microCMSのID（移行時の互換性のため） |
| ページID | `id` | 文字列（1行） | ✓ | ページID（自動採番プラグインで生成） |

### 設定

- **レコード数**: ページごとに1レコード（`page_id`で識別）
- **ページID**: 自動採番プラグインで生成（既存プラグインを使用、実装不要）
- **公開フィールドの選択肢**: 「開発」「本番」（両方選択可能）

### データ取得時のフィルタリング

- 開発環境ビルド: `publish` に「開発」が含まれ、かつ `page_id` が一致するレコードを取得
- 本番環境ビルド: `publish` に「本番」が含まれ、かつ `page_id` が一致するレコードを取得

### ページ識別子の例

- `company`: 会社概要ページ
- `aboutjoyzo`: ジョイゾーについてページ（将来追加想定）
- `story`: ストーリーページ（将来追加想定）

## 3. Webhook設定

### トリガー条件

- レコード追加時
- レコード編集時
- レコード削除時

### Webhook URL

GitHub Actionsの `repository_dispatch` エンドポイントを使用します。

**注意**: kintoneのWebhook機能では直接GitHub Actionsを呼び出せないため、以下のいずれかの方法を採用する必要があります：

1. **中間サーバー（推奨）**: kintone Webhook → 中間サーバー → GitHub Actions
2. **kintone REST API + スクリプト**: kintoneのJavaScriptカスタマイズでGitHub APIを呼び出し

### 送信データ形式

```json
{
  "type": "CREATE|EDIT|DELETE",
  "app": {
    "id": "アプリID"
  },
  "record": {
    "レコード情報"
  }
}
```

### GitHub Actionsへの通知方法

中間サーバーまたはkintoneのJavaScriptカスタマイズから、以下のようにGitHub APIを呼び出します：

```bash
curl -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer YOUR_GITHUB_TOKEN" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  https://api.github.com/repos/{owner}/{repo}/dispatches \
  -d '{
    "event_type": "kintone-update",
    "client_payload": {
      "environment": "development|production",
      "payload": { "webhook data" }
    }
  }'
```

## 4. APIトークン設定

### 必要な権限

- レコードの閲覧
- レコードの追加
- レコードの編集
- レコードの削除

### トークン管理

- 1つのAPIトークンで両アプリにアクセス可能
- セキュリティのため、最小限の権限で設定

## 5. 自動採番プラグインの設定

### プラグインの選択

kintoneのプラグインストアから、自動採番機能を提供するプラグインを選択してインストールします。

### 設定方法

1. アプリの設定画面を開く
2. プラグイン設定で自動採番プラグインを有効化
3. `id` フィールドに対して自動採番を設定
4. 採番形式を設定（例: 連番、日付+連番など）

## 6. 画像の扱い

### 画像の保存先

- kintoneのファイルフィールドにアップロードされた画像は、Webhook処理時に自動的にS3の公開バケットにアップロードされます
- JSONファイルにはS3のURLが保存されます
- サイトではS3のURLを参照して画像を表示します

### S3バケットの設定

- バケットは公開読み取り可能に設定
- CORS設定が必要な場合は適切に設定

## 7. 環境変数の設定

GitHub ActionsのSecretsに以下の環境変数を設定してください：

- `KINTONE_BASE_URL`: kintoneのベースURL
- `KINTONE_API_TOKEN`: kintone APIトークン
- `KINTONE_NEWS_APP_ID`: ニュース管理アプリのアプリID
- `KINTONE_PAGES_APP_ID`: 固定ページ管理アプリのアプリID
- `AWS_ACCESS_KEY_ID`: S3アクセス用のAWSアクセスキーID
- `AWS_SECRET_ACCESS_KEY`: S3アクセス用のAWSシークレットキー
- `AWS_REGION`: S3バケットのリージョン
- `S3_BUCKET_NAME`: 画像保存用のS3バケット名
- `S3_PUBLIC_URL`: S3の公開URL

